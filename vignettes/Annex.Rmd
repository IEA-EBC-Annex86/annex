---
title: "Getting Started"
author: "Reto Stauffer"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
bibliography: Annex.bib
link-citations: true
vignette: >
  %\VignetteIndexEntry{Annex: Annex86 Data Analysis Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteDepends{Formula}
  %\VignetteKeywords{Annex86}
  %\VignettePackage{Annex}
---

```{r setup, include = FALSE}
suppressPackageStartupMessages(library('zoo'))
suppressPackageStartupMessages(library('Formula'))
```


## Reading Demo Data

This article is using a tiny demo data set called
[`Bedroom.txt`](../inst/data/Bedroom.txt) (shipped
with the package).

```{r, include = FALSE}
# Make a copy when building the article
file <- system.file("data/Bedroom.txt", package = "Annex")
file.copy(file, "Bedroom.txt")
```

As the data sets from the different campagnes will
come in various formats, the `Annex` package cannot
provide import functions, however, a series of 
demos are provided to read some common formats.

In this case, the data set comes as a text/CSV file
which can easily be read using _R_s `read.table()`
function (see `?read.table`). The demo data set
comes in the format expected by the convenience
funtion `read.csv()`, thus all needed is ...

```{r}
raw <- read.csv("Bedroom.txt")
```

The return is a `r class(raw)` with `r nrow(raw)` observations
and `r ncol(raw)` variables.

```{r}
dim(raw)           # Dimension of the object
summary(raw)       # Object summary
head(raw)          # Content of the demo object
names(raw)         # Names of the variables
```

## Preparing data

The function `annex()` is used to prepare the data
for the further analysis. It requires a \code{formula} which
specifies what the (numeric) variables are, where the date
and time information is stored, and (if available) what
the grouping information is. The grouping is based on
the study, home (building), and room.

This can be done in two ways:

1. This information is _not_ in the data set (`raw`); in this
   case the data can be provided via an argument \code{meta} when
   calling `annex()`.
2. The information _is_ already stored in the data set (`raw`).
   In this case, they can be used directly. This allows to
   process multiple 'rooms' at once.

**Preparing date and time information**

The function `annex()` requires the date and time
information to be in one variable (one column) and be
of class `POSIXt`. At the moment, the information is
of class `r class(raw$datetime)`:

```{r}
class(raw$datetime)
```

... and must be converted first; using the
function `as.POSIXct()` (see `?as.POSIXct()` for more details).

```{r}
raw <- transform(raw, datetime = as.POSIXct(raw$datetime,
                                            format = "%Y-%m-%d %H:%M:%S", tz = "UTC"))
class(raw$datetime)
```


**Information about study, home, and room not included**

Currently, the object `raw` does not contain the grouping
information (study, home, and room). In this case, they can
be provided via the `meta` argument.

The `formula` specifies how the variables to be aggregated
are named and where the date and time information is stored.
_Note:_ The date information must be of class `POSIXt`
(datetime object).

```{r}
library("Annex")
data1 <- annex(temp + co2 + voc ~ datetime,
               data = raw,
               meta = list(study = 51, home = "foo", room = "WZ"))
```

The function `annex()` will (based on the formula) check
if all required information is available and of the correct type,
modify the data set, and returns an object of class
`r deparse(class(data1))` which looks as follows:

```{r}
class(data1)
head(data1, n = 2)
```


**Information about study, home, and room already included**

In case the information about study, home, and room is already included,
they can be specified in the `formula`. Note that this also allows to
process data sets containing observations from multiple studies, homes,
or rooms.

As our data set `raw` does not yet contain this information, they are
added in the following just for demonstration.

```{r}
raw2 <- transform(raw, study = 9901, home = "bar", room = "Garage")
head(raw2, n = 2)
```

When calling `annex()` the grouping can now be specified as follows:

```{r}
data2 <- annex(temp + co2 + voc ~ datetime | study + home + room,
               data = raw2)
class(data2)
head(data2, n = 2)
```

Note that `meta` is no longer required (will be ignored if set).

**Description of the variables in `data1` and `data2`**

* `datetime`: Unmodified time information
* `study`, `home`, `room`: Information (from `meta`; constant in this case)
* `season`: Additional season information the observation falls into
* `tod`: Time of day information the observation falls into
* ... followed by the numeric variables to be analyzed in the next step.

Note that the naming (except `season` and `tod`) may differ
as they do follow the `formula` specification and the original data set.


## Checking regularity

The S3 method `is.regular()` can be used to check whether or
not the observations of an `annex` object is strictly regular
(or at least regular). Regularity means that the intervals
between observations are always a multiple of the shortest
interval recorded (e.g., hourly data).

Strictly regular checks if the intervals are all the same,
i.e. hourly without any gaps.

The return of the function is a logical vector where the name
corresponds to 'study - home - room'.

```{r}
is.regular(data1)                     # by default strict = TRUE
is.regular(data2, strict = FALSE)
```

In this case the time series is regular, but not strictly regular
which indicates that there are some gaps in the time series.


## Object Statistics/Analysis

```{r}
wide <- annex_stats(data1)
head(wide, n = 3)
long <- annex_stats(data1, format = "long")
head(long, n = 6)
```

The interactive table below shows the content of the object `long`
returned by `annex_stats()` with `format = "long"`.

```{r, echo = FALSE}
library("DT")
datatable(long)
```


## Object Summary

By default, `summary()` returns the Rs standard summary output
for each group (study, room, home), using `type = "default"`.

```{r}
summary(data1)
```

However, the argument `type` is set to `"statistics"`, 
a statistical summary will be displayed. This is the same
as returned by `statistics(data1)` explained in the next section.


## Performing the analysis

TODO(R)


```{r, include = FALSE}
# Getting rid of the copy of the demo file
file.remove("Bedroom.txt")
```

