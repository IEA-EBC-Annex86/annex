---
title: "With Config"
author: "Reto Stauffer"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
bibliography: Annex.bib
link-citations: true
vignette: >
  %\VignetteIndexEntry{Annex: Annex86 Data Analysis Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteDepends{Formula}
  %\VignetteKeywords{Annex86}
  %\VignettePackage{Annex}
---

```{r setup, include = FALSE}
suppressPackageStartupMessages(library('zoo'))
suppressPackageStartupMessages(library('Formula'))
```

## Introduction

Some users may have data for multiple rooms in one
file (CSV, Excel). To prepare the data for further
processing, the Annex package provides a function
`prepare_anenx()` which takes up (i) the data set
plus (ii) a 'config' object.

The 'config' object is a `data.frame` containing
the following information:

* `column`: The name of the column in the CSV/Excel file
* `variable`: The name of the observed/measured variable.
    _Note:_ One column is special and must exist, namely
    one row in the config file where `variable = "datetime"`
    which defines the column (CSV/Excel file) where the
    datetime information is stored; must be in one column.
* `study`: Name of the study
* `home`: Name of the building
* `room`: Name of the room

TODO(R): Currently `study`, `home` and `room` can be anything,
and I am quite sure I messed it up in the demo file; currently
good enough for development and testing.

What we would like to have is the following:

* Read the data
* Prepare the 'config'
* Call `prepare_annex(data, config)`

... and then do the further analysis.


# The configuration

```{r, include = FALSE}
# Make a copy when building the article
file <- system.file("data/demo_UIBK_config.csv", package = "Annex")
file.copy(file, "demo_UIBK_config.csv")
```

The config must be a `data.frame` with specific content,
the package does not care where this `data.frame` comes
from. In this case we are using a `.csv`
called `r xfun::embed_file("demo_UIBK_config.csv", text = "demo_UIBK_config.csv")`
(shipped with the package).

All we need is to get the data into R, in this case all we need is:

```{r}
config <- read.csv("demo_UIBK_config.csv")
head(config)
```

### Checking the config object

We _could_ now check if this object is valid using the `check_config()`
function. This is not mandatory as it will be done inside
`prepare_annex()` in any case. However, let's try:

```{r}
library("Annex")
check_config(config)
```

... no error, all fine.


# The data

```{r, include = FALSE}
# Make a copy when building the article
file <- system.file("data/demo_UIBK.xlsx", package = "Annex")
file.copy(file, "demo_UIBK.xlsx")
```

I am using the UIBK example data set (XLSX format) but have
cut down the data set to the first 1500 observations only.
The data set used is `r xfun::embed_file("demo_UIBK.xlsx", text = "demo_UIBK.xlsx")`
(also shipped with the package; thus reduced in size).

Again, all the user has to do is to import the data using
his preferred method. Here we make use of the [`readxl`](https://cran.r-project.org/package=readxl).

```{r}
library("readxl")
raw_df <- as.data.frame(read_excel("demo_UIBK.xlsx"))
head(raw_df[, 1:3])
```

The output above only shows the first 6 rows and 3 columns, the
entire data set is much larger. As shown, the names of the
variables are as in the XLSX file.

# Preparing data

We can now use this `raw_df` object in combination with our
`config` to prepare the data. 

```{r}
devtools::load_all("../")
prepared_df <- prepare_annex(raw_df, config)
head(prepared_df)
```

As shown, the data set `raw_df` has been brought into a new format.

* `datetime`: time of observation
* `ID`: unique identifier for `<study>:<home>:<room>`
* ... followed by all variables found.

As not all variables are available for all rooms, there can be
quite a lot of `NA`s in the prepared data set!

# Performing the analysis

The object `prepared_df` is now ready to (i) create an object
of class `"annex"` and perform the analysis.

Just for fun, even if it does not make most sense

### Prepare `annex` object

TODO(R): Variable name `del-CO2` can't be used in the formula;
extend config checker to not allow this (and limit variable names
to `[A-Za-z_]`).

```{r}
annex_df <- annex(CO2 + rH + T + V + Pyro ~ datetime | ID, data = prepared_df)
head(annex_df)
```

### Just for fun ...

```{r, fig.width = 8, fig.height = 11, out.width = "100%"}
par(mar = c(1, 5, 1, 1))
plot(annex_df)
```

### Perform analysis

TODO(R): Still contains the error seen yesterday.

```{r}
stats <- annex_stats(annex_df, format = "long")
head(stats)
```



```{r, include = FALSE}
files <- c("demo_UIBK_config.csv", "demo_UIBK.xlsx")
for (f in files) {
    if (file.exists(f)) file.remove(f)
}
```







